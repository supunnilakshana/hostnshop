Docker container error log


atasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 1
hostnshop-app | Environment variables loaded from .env
hostnshop-app | Prisma schema loaded from prisma/schema.prisma
hostnshop-app | Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 0
hostnshop-app | Environment variables loaded from .env
hostnshop-app | Prisma schema loaded from prisma/schema.prisma
hostnshop-app | Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 1
hostnshop-app | Environment variables loaded from .env
hostnshop-app | Prisma schema loaded from prisma/schema.prisma
hostnshop-app | Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 1
hostnshop-app | Environment variables loaded from .env
hostnshop-app | Prisma schema loaded from prisma/schema.prisma
hostnshop-app | Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 1
hostnshop-app | Environment variables loaded from .env
hostnshop-app | Prisma schema loaded from prisma/schema.prisma
hostnshop-app | Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 1
hostnshop-app | Environment variables loaded from .env
hostnshop-app | Prisma schema loaded from prisma/schema.prisma
hostnshop-app | Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-damp-dew-a5n8sucb-pooler.us-east-2.aws.neon.tech"
hostnshop-app |
hostnshop-app | 5 migrations found in prisma/migrations
hostnshop-app |
hostnshop-app |
hostnshop-app | No pending migrations to apply.
hostnshop-app | Creating/updating admin user...
hostnshop-app | /app/node_modules/.prisma/client/default.js:43
hostnshop-app | throw new Error('@prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.');
hostnshop-app | ^
hostnshop-app |
hostnshop-app | Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.
hostnshop-app | at new PrismaClient (/app/node_modules/.prisma/client/default.js:43:11)
hostnshop-app | at Object.<anonymous> (/app/scripts/create-admin-user.js:6:16)
hostnshop-app | at Module._compile (node:internal/modules/cjs/loader:1529:14)
hostnshop-app | at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
hostnshop-app | at Module.load (node:internal/modules/cjs/loader:1275:32)
hostnshop-app | at Module._load (node:internal/modules/cjs/loader:1096:12)
hostnshop-app | at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
hostnshop-app | at node:internal/main/run_main_module:28:49
hostnshop-app |
hostnshop-app | Node.js v20.19.2
hostnshop-app exited with code 1
hostnshop-app | Environment variables l


Project structure

Project Path: hostnshop

Source Tree:

```
hostnshop
├── tools
│ ├── pg.md
│ ├── pc.json
│ ├── scripts
│ │ └── script.sh
│ └── test.md
├── postcss.config.mjs
├── Dockerfile
├── prisma
│ ├── migrations
│ │ ├── migration_lock.toml
│ │ ├── 20250517015413_add_file
│ │ │ └── migration.sql
│ │ ├── 20250203144713_init
│ │ │ └── migration.sql
│ │ ├── 20250311114621_add_promo_banner_models
│ │ │ └── migration.sql
│ │ ├── 20250517023847_add_file1
│ │ │ └── migration.sql
│ │ └── 20250517020456_add_file1
│ │ └── migration.sql
│ └── schema.prisma
├── README.md
├── tailwind.config.ts
├── public
│ ├── icon-192x192.png
│ ├── icon-256x256.png
│ ├── lap.jpg
│ ├── icon-384x384.png
│ ├── file.svg
│ ├── uploads
│ │ └── product
│ │ ├── af8da857-8d63-41ba-98a4-883817c05039.jpg
│ │ ├── f2b1ee62-87b5-4d62-84f6-83154aefe2bf.jpg
│ │ ├── 912c7c69-39dd-4aa0-bc26-d71010280894.jpg
│ │ ├── d8d5fd6f-6588-4074-b575-be6089ffbadd.jpg
│ │ ├── a22514f4-a50a-41e4-a55e-f72d58a8c363.png
│ │ ├── ea5279fa-49fa-4d30-a578-73f477ddfa17.png
│ │ ├── fdc72aa6-1dfe-47b9-aebb-4479ef68f553.jpg
│ │ ├── 5f7a3d73-b1f1-4590-8069-168f842f7274.jpg
│ │ ├── 154abe15-d4e0-4779-80a7-835975d7192b.jpg
│ │ ├── 5012db70-5f5e-4a92-ba06-84371acbf2a7.jpg
│ │ └── 68ca62ef-dc3e-4552-af81-c22e3b91cc86.jpg
│ ├── logo.png
│ ├── vercel.svg
│ ├── manifest.json
│ ├── next.svg
│ ├── icon-512x512.png
│ ├── globe.svg
│ ├── assets
│ │ └── images
│ │ ├── team.jpg
│ │ ├── headphones.jpg
│ │ ├── contact-hero.jpg
│ │ ├── products-hero.jpg
│ │ ├── smartphone.jpg
│ │ ├── placeholder.png
│ │ ├── avatar.jpg
│ │ ├── electronics.jpg
│ │ ├── about-hero.jpg
│ │ ├── hero-banner1.jpg
│ │ ├── hero-banner.jpg
│ │ ├── HostNShop.png
│ │ ├── clothing.jpg
│ │ └── smartwatch.jpg
│ ├── window.svg
│ ├── workbox-4754cb34.js
│ └── sw.js
├── docker-entrypoint.sh
├── package-lock.json
├── package.json
├── scripts
│ ├── create-admin-user.js
│ └── configure-branding.js
├── components.json
├── tsconfig.json
├── docker-compose.yml
├── test.md
├── eslint.config.mjs
├── next.config.ts
└── src
├── app
│ ├── home
│ │ └── page.tsx
│ ├── favicon.ico
│ ├── products
│ │ ├── [id]
│ │ │ └── page.tsx
│ │ └── page.tsx
│ ├── about-us
│ │ └── page.tsx
│ ├── auth
│ │ ├── register
│ │ │ └── page.tsx
│ │ └── login
│ │ └── page.tsx
│ ├── admin
│ │ ├── customers
│ │ │ └── page.tsx
│ │ ├── settings
│ │ │ └── page.tsx
│ │ ├── home
│ │ │ └── page.tsx
│ │ ├── products
│ │ │ └── page.tsx
│ │ ├── category
│ │ │ └── page.tsx
│ │ ├── orders
│ │ │ └── page.tsx
│ │ └── login
│ │ └── page.tsx
│ ├── checkout
│ │ └── page.tsx
│ ├── profile
│ │ └── page.tsx
│ ├── layout.tsx
│ ├── contact-us
│ │ └── page.tsx
│ ├── cart
│ │ └── page.tsx
│ ├── api
│ │ ├── products
│ │ │ ├── route.ts
│ │ │ └── [id]
│ │ │ └── route.ts
│ │ ├── auth
│ │ │ ├── refresh
│ │ │ │ └── route.ts
│ │ │ ├── signup
│ │ │ │ └── route.ts
│ │ │ └── signin
│ │ │ └── route.ts
│ │ ├── admin
│ │ │ └── dashboard
│ │ │ ├── recent-orders
│ │ │ │ └── route.ts
│ │ │ ├── low-stock
│ │ │ │ └── route.ts
│ │ │ ├── summary
│ │ │ │ └── route.ts
│ │ │ └── analytics
│ │ │ └── route.ts
│ │ ├── storage
│ │ │ └── upload
│ │ │ ├── route.ts
│ │ │ └── files
│ │ │ ├── [fileId]
│ │ │ │ └── route.ts
│ │ │ └── route.ts
│ │ ├── users
│ │ │ ├── customers
│ │ │ │ └── route.ts
│ │ │ ├── statistics
│ │ │ │ └── route.ts
│ │ │ └── route.ts
│ │ ├── orders
│ │ │ ├── route.ts
│ │ │ ├── [id]
│ │ │ │ ├── cancel
│ │ │ │ │ └── route.ts
│ │ │ │ ├── status
│ │ │ │ │ └── route.ts
│ │ │ │ └── route.ts
│ │ │ └── analytics
│ │ │ └── route.ts
│ │ ├── categories
│ │ │ ├── route.ts
│ │ │ └── [id]
│ │ │ └── route.ts
│ │ └── notifications
│ │ └── route.ts
│ ├── page.tsx
│ └── globals.css
├── data_access
│ ├── db_client
│ │ └── prisma_client.ts
│ ├── repositories
│ │ ├── iorder_item.repository.ts
│ │ ├── product.repository.ts
│ │ ├── ireview.repository.ts
│ │ ├── order_item.repository.ts
│ │ ├── file_storage.repository.ts
│ │ ├── ifile_storage.repository.ts
│ │ ├── iemail_sub.repository.ts
│ │ ├── category.repository.ts
│ │ ├── payment.repository.ts
│ │ ├── review.repository.ts
│ │ ├── inotification.repository.ts
│ │ ├── iuser.repository.ts
│ │ ├── iproduct.repository.ts
│ │ ├── icategory.repository.ts
│ │ ├── user.repository.ts
│ │ ├── notification.repository.ts
│ │ ├── promo.repository.ts
│ │ ├── email_sub.repository.ts
│ │ ├── shipping_address.repository.ts
│ │ ├── order.repository.ts
│ │ ├── ipromo.repository.ts
│ │ ├── ishipping_address.repository.ts
│ │ ├── ipayment.repository.ts
│ │ └── iorder.repository.ts
│ ├── models
│ └── mappers
│ └── prisma
│ ├── order.mapper.ts
│ ├── shipping_address.mapper.ts
│ ├── order_item.mapper.ts
│ ├── review.mapper.ts
│ ├── notification.mapper.ts
│ ├── promo_code.mapper.ts
│ ├── product.mapper.ts
│ ├── user.mapper.ts
│ ├── email_subscription.mapper.ts
│ ├── payment.mapper.ts
│ ├── category.mapper.ts
│ └── index.ts
├── utils
│ └── branding.ts
├── shared
│ ├── middleware
│ │ └── auth.middleware.ts
│ ├── types
│ │ ├── api.types.ts
│ │ ├── product.ts
│ │ ├── orders.ts
│ │ ├── auth.types.ts
│ │ ├── categories.ts
│ │ └── index.ts
│ ├── decorators
│ │ └── auth.decorators.ts
│ ├── enums
│ │ ├── auth.enum.ts
│ │ ├── app.enum.ts
│ │ └── index.ts
│ ├── utils
│ │ └── jwt_util.ts
│ ├── dtos
│ │ ├── review.dto.ts
│ │ ├── order.dto.ts
│ │ ├── user.dto.ts
│ │ ├── order_item.dto.ts
│ │ ├── category.dto.ts
│ │ ├── file_storage.dto.ts
│ │ ├── index.ts
│ │ ├── notification.dto.ts
│ │ ├── product.dto.ts
│ │ ├── email_subscription.dto.ts
│ │ └── shipping_address.dto.ts
│ ├── lib
│ │ └── sdcn
│ │ └── utils.ts
│ └── data
│ ├── productList.ts
│ ├── product.ts
│ ├── categoryList.ts
│ └── orderList.ts
├── lib
│ ├── utils.ts
│ ├── utils
│ │ └── imageUtil.ts
│ ├── api
│ │ ├── orderService.ts
│ │ ├── notificationService.ts
│ │ ├── reviewService.ts
│ │ ├── authService.ts
│ │ ├── userService.ts
│ │ ├── client.ts
│ │ ├── productService.ts
│ │ ├── dashboardService.ts
│ │ └── categoryService.ts
│ ├── provider.tsx
│ └── store
│ ├── cartStore.ts
│ ├── authStore.ts
│ └── notificationStore.ts
├── application
│ ├── config
│ │ └── service_locator.ts
│ ├── controllers
│ │ ├── auth.controller.ts
│ │ ├── dashboard.controller.ts
│ │ ├── order.controller.ts
│ │ ├── storage.controller.ts
│ │ ├── user.controller.ts
│ │ ├── payment.controller.ts
│ │ ├── category.controller.ts
│ │ ├── product.controller.ts
│ │ └── base.controller.ts
│ └── services
│ ├── category.service.ts
│ ├── auth.service.ts
│ ├── file_storage.service.ts
│ ├── dashboard.service.ts
│ ├── payment.service.ts
│ ├── order.service.ts
│ ├── notification.service.ts
│ ├── user.service.ts
│ └── product.service.ts
└── presentation
├── components
│ ├── mainWrapper.tsx
│ ├── ui
│ │ ├── tabs.tsx
│ │ ├── card.tsx
│ │ ├── slider.tsx
│ │ ├── label.tsx
│ │ ├── switch.tsx
│ │ ├── radio-group.tsx
│ │ ├── dialog.tsx
│ │ ├── badge.tsx
│ │ ├── table.tsx
│ │ ├── button.tsx
│ │ ├── checkbox.tsx
│ │ ├── dropdown-menu.tsx
│ │ ├── select.tsx
│ │ ├── textarea.tsx
│ │ ├── input.tsx
│ │ └── form.tsx
│ ├── products-datatable.tsx
│ ├── category-datatable.tsx
│ ├── orderStatusBadge.tsx
│ ├── orderDetails.tsx
│ ├── admin
│ │ ├── order
│ │ │ └── AdminOrderDetails.tsx
│ │ └── layout
│ │ └── adminLayout.tsx
│ ├── footer.tsx
│ ├── dashboard
│ │ ├── productList.tsx
│ │ ├── orderList.tsx
│ │ ├── incomeTimeline.tsx
│ │ ├── fullProductList.tsx
│ │ └── summary.tsx
│ ├── header.tsx
│ ├── sidebar.tsx
│ ├── account
│ │ ├── ProfileForm.tsx
│ │ ├── OrderDetailsModal.tsx
│ │ ├── NotificationsSettings.tsx
│ │ ├── AddressBook.tsx
│ │ ├── OrderHistory.tsx
│ │ └── PasswordChangeForm.tsx
│ ├── client
│ │ ├── product
│ │ │ ├── ProductGrid.tsx
│ │ │ ├── ReviewList.tsx
│ │ │ ├── UserReviews.tsx
│ │ │ ├── ProductCard.tsx
│ │ │ ├── ReviewForm.tsx
│ │ │ ├── ProductDetail.tsx
│ │ │ ├── ReviewStats.tsx
│ │ │ └── productFilter.tsx
│ │ ├── map
│ │ │ └── mapComponenet.tsx
│ │ ├── cart
│ │ │ ├── cartSummery.tsx
│ │ │ ├── cartItem.tsx
│ │ │ └── cartCheckout.tsx
│ │ └── header
│ │ └── NavBar.tsx
│ └── ordersTable.tsx
├── hooks
└── pages
├── loginPage.tsx
├── orderPage.tsx
├── admin
│ ├── adminDashboardPage.tsx
│ ├── orderPage.tsx
│ ├── adminSetttingsPage.tsx
│ ├── categoryPage.tsx
│ ├── productPage.tsx
│ └── customerPage.tsx
├── dashboard
│ └── dashboard.tsx
├── categoryPage.tsx
├── productPage.tsx
├── client
│ └── clientHomePage.tsx
└── homePage.tsx

```
Docker file 

# Base Node.js image
FROM node:20-alpine AS base

# Install dependencies only when needed
FROM base AS deps
# Install dependencies needed for native modules and properly symlink python
RUN apk add --no-cache libc6-compat python3 make g++ && \
ln -sf /usr/bin/python3 /usr/bin/python
WORKDIR /app

# Copy package files
COPY package.json package-lock.json* ./

# Install dependencies
RUN npm ci

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Set environment variables from build args
ARG APP_NAME
ARG APP_DESCRIPTION
ARG CONTACT_EMAIL
ARG CONTACT_PHONE
ARG ADMIN_EMAIL
ARG ADMIN_PASSWORD
ARG DATABASE_URL

ENV NEXT_PUBLIC_APP_NAME=$APP_NAME
ENV NEXT_PUBLIC_APP_DESCRIPTION=$APP_DESCRIPTION
ENV NEXT_PUBLIC_CONTACT_EMAIL=$CONTACT_EMAIL
ENV NEXT_PUBLIC_CONTACT_PHONE=$CONTACT_PHONE
ENV ADMIN_EMAIL=$ADMIN_EMAIL
ENV ADMIN_PASSWORD=$ADMIN_PASSWORD
ENV DATABASE_URL=$DATABASE_URL

# Install Python and create symlink
RUN apk add --no-cache python3 make g++ && \
ln -sf /usr/bin/python3 /usr/bin/python

# Generate Prisma client
RUN npx prisma generate

# Create a temporary .env file for the build
RUN touch .env
RUN echo "DATABASE_URL=$DATABASE_URL" >> .env
RUN echo "NEXT_PUBLIC_APP_NAME=$NEXT_PUBLIC_APP_NAME" >> .env
RUN echo "NEXT_PUBLIC_APP_DESCRIPTION=$NEXT_PUBLIC_APP_DESCRIPTION" >> .env
RUN echo "NEXT_PUBLIC_CONTACT_EMAIL=$NEXT_PUBLIC_CONTACT_EMAIL" >> .env
RUN echo "NEXT_PUBLIC_CONTACT_PHONE=$NEXT_PUBLIC_CONTACT_PHONE" >> .env

# Add standalone mode to next.config.ts and disable type checking/linting
RUN sed -i "s/const nextConfig: NextConfig = {/const nextConfig: NextConfig = { output: 'standalone', eslint: { ignoreDuringBuilds: true }, typescript: { ignoreBuildErrors: true },/g" next.config.ts || echo "Failed to update next.config.ts, may need manual update"

# Explicitly rebuild bcrypt from source before building
RUN npm rebuild bcrypt --build-from-source

# Disable Next.js telemetry
ENV NEXT_TELEMETRY_DISABLED=1

# Build with telemetry disabled
RUN npm run build

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

# Install build dependencies for rebuilding bcrypt
RUN apk add --no-cache python3 make g++ && \
ln -sf /usr/bin/python3 /usr/bin/python

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy public files
COPY --from=builder /app/public ./public

# Set the correct permission for prerender cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Automatically leverage output traces to reduce image size
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Copy package.json and lock file
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/package-lock.json ./package-lock.json

# Copy the prisma directory including schema and migrations
COPY --from=builder /app/prisma ./prisma/

# Copy node_modules from builder (important to include the Prisma client)
COPY --from=builder /app/node_modules ./node_modules

# Create scripts directory
RUN mkdir -p scripts


# Copy scripts and entrypoint script
COPY --from=builder /app/scripts ./scripts/
COPY --from=builder /app/docker-entrypoint.sh ./docker-entrypoint.sh
RUN npx prisma generate
RUN ls -la node_modules/.prisma/client
RUN chmod +x ./docker-entrypoint.sh




# Ensure that prisma gets regenerated in the runtime container

# Print primsa c;linet is working


RUN npx prisma generate
RUN ls -la node_modules/.prisma/client

USER nextjs

EXPOSE 3000

ENV PORT 3000
# set hostname to localhost
ENV HOSTNAME "0.0.0.0"

# Start the application
CMD ["./docker-entrypoint.sh"]

======docker-entrypoint.sh===
#!/bin/sh
set -e

echo "Current directory: $(pwd)"
echo "Listing directory contents:"
ls -la

# Run Prisma migrations
echo "Running database migrations..."
npx prisma migrate deploy

# Generate Prisma client to ensure it's available at runtime
echo "Generating Prisma client..."
npx prisma generate

# Verify client was generated
echo "Checking for Prisma client:"
ls -la node_modules/.prisma/client

# Check if admin user needs to be created
if [ -n "$ADMIN_EMAIL" ] && [ -n "$ADMIN_PASSWORD" ]; then
echo "Creating/updating admin user..."
# Don't use 'node ./scripts/create-admin-user.js' as it might not find the module
node scripts/create-admin-user.js
fi

# Apply branding configuration
if [ -n "$NEXT_PUBLIC_APP_NAME" ] || [ -n "$NEXT_PUBLIC_APP_DESCRIPTION" ] || [ -n "$NEXT_PUBLIC_CONTACT_EMAIL" ] || [ -n "$NEXT_PUBLIC_CONTACT_PHONE" ]; then
echo "Applying branding configuration..."
node scripts/configure-branding.js
fi

# Start the Next.js application
echo "Starting HostNShop application..."
exec node server.js


-------Composer file ---
version: '3.8'

services:
postgres:
image: postgres:15-alpine
container_name: hostnshop-db
environment:
POSTGRES_USER: ${POSTGRES_USER:-postgres}
POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
POSTGRES_DB: ${POSTGRES_DB:-hostnshop}
ports:
- "5432:5432"
volumes:
- postgres_data:/var/lib/postgresql/data
healthcheck:
test: ["CMD-SHELL", "pg_isready -U postgres"]
interval: 10s
timeout: 5s
retries: 5

hostnshop:
build:
context: .
dockerfile: Dockerfile
args:
APP_NAME: ${APP_NAME:-HostNShop}
APP_DESCRIPTION: ${APP_DESCRIPTION:-"E-commerce application"}
CONTACT_EMAIL: ${CONTACT_EMAIL:-"contact@hostnshop.com"}
CONTACT_PHONE: ${CONTACT_PHONE:-"+1 (555) 123-4567"}
ADMIN_EMAIL: ${ADMIN_EMAIL:-"admin@hostnshop.com"}
ADMIN_PASSWORD: ${ADMIN_PASSWORD:-"Admin123!"}
DATABASE_URL: ${DATABASE_URL:-"postgresql://postgres:postgres@postgres:5432/hostnshop?schema=public"}
container_name: hostnshop-app
depends_on:
postgres:
condition: service_healthy
environment:
NODE_ENV: production
DATABASE_URL: ${DATABASE_URL:-"postgresql://postgres:postgres@postgres:5432/hostnshop?schema=public"}
JWT_SECRET: ${JWT_SECRET:-"your-secret-key"}
JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-"your-refresh-secret-key"}
NEXT_PUBLIC_APP_NAME: ${APP_NAME:-HostNShop}
NEXT_PUBLIC_APP_DESCRIPTION: ${APP_DESCRIPTION:-"E-commerce application"}
NEXT_PUBLIC_CONTACT_EMAIL: ${CONTACT_EMAIL:-"contact@hostnshop.com"}
NEXT_PUBLIC_CONTACT_PHONE: ${CONTACT_PHONE:-"+1 (555) 123-4567"}
NEXT_PUBLIC_LOGO_PATH: ${LOGO_PATH:-"/assets/images/HostNShop.png"}
NEXT_PUBLIC_FAVICON_PATH: ${FAVICON_PATH:-"/favicon.ico"}
ADMIN_EMAIL: ${ADMIN_EMAIL:-"admin@hostnshop.com"}
ADMIN_PASSWORD: ${ADMIN_PASSWORD:-"Admin123!"}
ports:
- "3000:3000"
restart: unless-stopped

volumes:
postgres_data:

create-admin-user.js

/* eslint-disable @typescript-eslint/no-require-imports */
/* eslint-disable @typescript-eslint/no-unused-vars */
// Modified create-admin-user.js
const {execSync} = require("child_process");
const path = require("path");

// Run prisma generate explicitly before using the client
console.log("Generating Prisma client...");
try {
execSync("npx prisma generate", {stdio: "inherit"});
console.log("Prisma client generated successfully");
} catch (error) {
console.error("Error generating Prisma client:", error);
process.exit(1);
}

// Now import and use PrismaClient
const {PrismaClient} = require("@prisma/client");
const bcrypt = require("bcrypt"); // or bcryptjs if you switched

const prisma = new PrismaClient();

// Rest of your admin user creation logic
async function createAdminUser() {
try {
const email = process.env.ADMIN_EMAIL;
const password = process.env.ADMIN_PASSWORD;

if (!email || !password) {
console.log(
"Admin email or password not provided. Skipping admin user creation."
);
return;
}

// Hash the password
const hashedPassword = await bcrypt.hash(password, 10);

// Check if admin user exists
const existingUser = await prisma.user.findUnique({
where: {email},
});

if (existingUser) {
// Update existing admin
await prisma.user.update({
where: {email},
data: {
password: hashedPassword,
role: "ADMIN",
},
});
console.log(`Updated admin user: ${email}`);
} else {
// Create new admin user
await prisma.user.create({
data: {
email,
password: hashedPassword,
role: "ADMIN",
name: "Admin",
},
});
console.log(`Created admin user: ${email}`);
}
} catch (error) {
console.error("Error creating/updating admin user:", error);
process.exit(1);
} finally {
await prisma.$disconnect();
}
}

createAdminUser();



